

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo - The Tau method &#8212; Shenfun executable demos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/mystnb.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"bmat": ["\\left[\\begin{array}"], "emat": ["\\end{array}\\right]"]}, "extensions": ["cancel.js", "AMSmath.js"]}})</script>
    <script async="async" src="https://unpkg.com/thebe-mikaem/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/seashell3.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Shenfun executable demos</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Shenfun executable demos
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Shenfun executable demos
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="poisson.html">
   Demo - 1D Poisson’s equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kleingordon.html">
   Demo - Cubic nonlinear Klein-Gordon equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="poisson3d.html">
   Demo - 3D Poisson’s equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="polarhelmholtz.html">
   Demo - Helmholtz equation in polar coordinates
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sphericalhelmholtz.html">
   Demo - Helmholtz equation on the unit sphere
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kuramatosivashinsky.html">
   Demo - Kuramato-Sivashinsky equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stokes.html">
   Demo - Stokes equations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="drivencavity.html">
   Demo - Lid driven cavity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rayleighbenard.html">
   Demo - Rayleigh Benard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="functions.html">
   Demo - Working with Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="surfaceintegration.html">
   Demo - Integration of functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="moebius.html">
   Demo - Eigenvalues on the Möbius strip
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fasttransforms.html">
   Demo - Some fast transforms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mixingbases.html">
   Demo - Mixed bases for the Helmholtz problem
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/content/tau.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/mikaem/shenfun-demos"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/mikaem/shenfun-demos/master?urlpath=tree/content/tau.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> On this page
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-tau-method-for-poisson-s-equation-in-1d">
   The tau method for Poisson’s equation in 1D
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implementation">
   Implementation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preamble">
     Preamble
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#manufactured-solution">
     Manufactured solution
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#discretization">
     Discretization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#variational-formulation">
     Variational formulation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fix-boundary-conditions">
     Fix boundary conditions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#solve-linear-equations">
     Solve linear equations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convergence-test">
     Convergence test
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#complete-solver">
   Complete solver
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <!-- dom:TITLE: Demo - The Tau method -->
<div class="section" id="demo-the-tau-method">
<h1>Demo - The Tau method<a class="headerlink" href="#demo-the-tau-method" title="Permalink to this headline">¶</a></h1>
<!-- dom:AUTHOR: Mikael Mortensen Email:mikaem@math.uio.no at Department of Mathematics, University of Oslo. -->
<!-- Author: -->  
<p><strong>Mikael Mortensen</strong> (email: <code class="docutils literal notranslate"><span class="pre">mikaem&#64;math.uio.no</span></code>), Department of Mathematics, University of Oslo.</p>
<p>Date: <strong>Jun 15, 2021</strong></p>
<p>Copyright 2021, Mikael Mortensen. Released under CC Attribution 4.0 license</p>
<p><strong>Summary.</strong> Shenfun has primarily been developed for the spectral Galerkin method.
However, there are other methods out there that make use of global basis
functions and variational principles. One such method, which has a lot in
common with the spectral Galerkin method, is the Tau method. The
principle difference between a Tau method and a spectral Galerkin method
is in the choice of basis functions. The spectral Galerkin method is
usually defined through function spaces where the boundary conditions
of the problem are already built in. The tau-method, on the other hand,
does not come with such restrictions. The tau-method usually considers
only the orthogonal basis, like pure Chebyshev or Legendre polynomials,
and derives differentiation matrices for these bases. The boundary conditions
are usually fixed by enforcing a couple of rows of the differentiation
matrix. In this demo we will show how the original tau-method can
be easily implemented using <a class="reference external" href="https://github.com/spectralDNS/shenfun">shenfun</a>.</p>
<div class="section" id="the-tau-method-for-poisson-s-equation-in-1d">
<h2>The tau method for Poisson’s equation in 1D<a class="headerlink" href="#the-tau-method-for-poisson-s-equation-in-1d" title="Permalink to this headline">¶</a></h2>
<p>Poisson’s equation is given on a domain <span class="math notranslate nohighlight">\([-1, 1]\)</span> as</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:poisson"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\nabla^2 u(x) = f(x) \quad \text{for }\, x \in [-1, 1], \label{eq:poisson} \tag{1}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto1"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
u(-1)=a, u(1)=b, \notag
\label{_auto1} \tag{2}
\end{equation}
\]</div>
<p>where <span class="math notranslate nohighlight">\(u(x)\)</span> is the solution, <span class="math notranslate nohighlight">\(f(x)\)</span> is a function and <span class="math notranslate nohighlight">\(a, b\)</span> are two possibly
non-zero constants.</p>
<p>To solve Eq. (<a class="reference external" href="#eq:poisson">1</a>) with the tau method we choose either
Legendre of Chebyshev basis functions <span class="math notranslate nohighlight">\(\phi_k\)</span>, and then look for
solutions</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:u"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
u(x) = \sum_{k=0}^{N-1} \hat{u}_k \phi_k(x), \label{eq:u} \tag{3}
\end{equation}
\]</div>
<p>where <span class="math notranslate nohighlight">\(N\)</span> is the size of the discretized problem and
<span class="math notranslate nohighlight">\(\hat{\mathbf{u}} = \{\hat{u}_k\}_{k=0}^{N-1}\)</span> are the unknown expansion
coefficients. For this function to satisfy the given boundary conditions, it is necessary
that</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:dirichleta"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
u(-1) = \sum_{k=0}^{N-1} \hat{u}_k \phi_k(-1) = \sum_{k=0}^{N-1}\hat{u}_{k}(-1)^k = a,
\label{eq:dirichleta} \tag{4} 
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="eq:dirichletb"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
u(+1) = \sum_{k=0}^{N-1} \hat{u}_k \phi_k(+1) = \sum_{k=0}^{N-1} \hat{u}_{k} = b,
\label{eq:dirichletb} \tag{5}
\end{equation}
\]</div>
<p>where we have use that <span class="math notranslate nohighlight">\(\phi_k(1) = 1\)</span> and <span class="math notranslate nohighlight">\(\phi_k(-1)=(-1)^k\)</span> for <span class="math notranslate nohighlight">\(k=0,1, \ldots, N-1\)</span>,
for either Chebyshev or Legendre polynomials <span class="math notranslate nohighlight">\(\phi_k\)</span>.</p>
<p>This gives two equations for the <span class="math notranslate nohighlight">\(N-1\)</span> unknowns in  <span class="math notranslate nohighlight">\(\{\hat{u}_k\}_{k=0}^{N-1}\)</span>.
We will now use variational principles, like in the Galerkin method, in order to
derive equations that can be used to close the remaining <span class="math notranslate nohighlight">\(N-3\)</span> unknowns.
To this end we multiply Poisson’s equation by a
test function <span class="math notranslate nohighlight">\(v\)</span>, a weight <span class="math notranslate nohighlight">\(w\)</span>, and integrate  over the domain</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:varform"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\int_{-1}^1 \nabla^2 u \, v \, w\, dx = \int_{-1}^1 f \, v\, w\, dx. \label{eq:varform} \tag{6}
\end{equation}
\]</div>
<p>The weight function depends on the choice of basis functions. For Chebyshev
it will be <span class="math notranslate nohighlight">\(1/\sqrt{1-x^2}\)</span>, whereas it is unity for Legendre.</p>
<p>Finally, we insert the trial function <span class="math notranslate nohighlight">\(u=\sum_{j=0}^{N-1}\hat{u}_j \phi_j\)</span> and
the test function <span class="math notranslate nohighlight">\(v=\phi_k\)</span>, to get</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:varform2"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\int_{-1}^1 \sum_{j=0}^{N-1} \nabla^2 \phi_j  \, \phi_k \, w\, dx \hat{u}_j = \int_{-1}^1 f \, \phi_k\, w\, dx. \label{eq:varform2} \tag{7}
\end{equation}
\]</div>
<p>This problem can be reformulated as a linear algebra problem,</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto2"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
a_{kj} \hat{u}_j = \tilde{f}_k, 
\label{_auto2} \tag{8}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto3"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
A \hat{\mathbf{{u}}} = \tilde{\mathbf{{f}}}.
\label{_auto3} \tag{9}
\end{equation}
\]</div>
<p>However, the matrix <span class="math notranslate nohighlight">\(A\in \mathbb{R}^{N \times N}\)</span> is singular because it
contains two zero rows. These two rows is where we implement the two boundary
conditions. By setting the rows as <span class="math notranslate nohighlight">\(a_{N-2, j}=1\)</span> and
<span class="math notranslate nohighlight">\(a_{N-1, j}= (-1)^j\)</span> for <span class="math notranslate nohighlight">\(j=0, 1, \ldots, N-1\)</span>, and fixing
the right hand side <span class="math notranslate nohighlight">\(\tilde{f}_{N-2}=a\)</span> and <span class="math notranslate nohighlight">\(\tilde{f}_{N-1}=b\)</span>, the
two boundary conditions will be satisfied.</p>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="preamble">
<h3>Preamble<a class="headerlink" href="#preamble" title="Permalink to this headline">¶</a></h3>
<p>We will solve Poisson’s equation using the <a class="reference external" href="https://github.com/spectralDNS/shenfun">shenfun</a> Python module. The first thing needed
is then to import some of this module’s functionality
plus some other helper modules, like <a class="reference external" href="https://numpy.org">Numpy</a> and <a class="reference external" href="https://sympy.org">Sympy</a>:</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shenfun</span> <span class="kn">import</span> <span class="n">inner</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">TestFunction</span><span class="p">,</span> <span class="n">TrialFunction</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> \
    <span class="n">project</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">Array</span><span class="p">,</span> <span class="n">FunctionSpace</span><span class="p">,</span> <span class="n">dx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">scp</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">lambdify</span>
</pre></div>
</div>
</div>
</div>
<p>We use <code class="docutils literal notranslate"><span class="pre">Sympy</span></code> for a manufactured solution and <code class="docutils literal notranslate"><span class="pre">Numpy</span></code> for testing.</p>
</div>
<div class="section" id="manufactured-solution">
<h3>Manufactured solution<a class="headerlink" href="#manufactured-solution" title="Permalink to this headline">¶</a></h3>
<p>The exact solution <span class="math notranslate nohighlight">\(u_e(x)\)</span> and the right hand side <span class="math notranslate nohighlight">\(f_e(x)\)</span> are created using
<code class="docutils literal notranslate"><span class="pre">Sympy</span></code> as follows</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">ue</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="n">fe</span> <span class="o">=</span> <span class="n">ue</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These solutions are now valid for a continuous domain. The next step is thus to
discretize, using a discrete mesh <span class="math notranslate nohighlight">\(\{x_j\}_{j=0}^{N-1}\)</span> and a finite number of
basis functions.</p>
</div>
<div class="section" id="discretization">
<h3>Discretization<a class="headerlink" href="#discretization" title="Permalink to this headline">¶</a></h3>
<p>We create a basis with a given number of basis functions, and extract the computational
mesh from the basis itself</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="s1">&#39;Chebyshev&#39;</span><span class="p">)</span>
<span class="c1">#T = FunctionSpace(N, &#39;Legendre&#39;)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we can either choose a Legendre or a Chebyshev basis.</p>
</div>
<div class="section" id="variational-formulation">
<h3>Variational formulation<a class="headerlink" href="#variational-formulation" title="Permalink to this headline">¶</a></h3>
<p>The variational problem (<a class="reference external" href="#eq:varform">6</a>) can be assembled using <code class="docutils literal notranslate"><span class="pre">shenfun</span></code>’s
<a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.forms.html#shenfun.forms.arguments.TrialFunction">TrialFunction</a>, <a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.forms.html#shenfun.forms.arguments.TestFunction">TestFunction</a> and <a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.forms.html#shenfun.forms.inner.inner">inner()</a> functions.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="c1"># Assemble differentiation matrix</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">div</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
<span class="c1"># Assemble right hand side</span>
<span class="n">fj</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">fe</span><span class="p">)</span>
<span class="n">f_hat</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">f_hat</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">fj</span><span class="p">,</span> <span class="n">output_array</span><span class="o">=</span><span class="n">f_hat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">sympy</span></code> function <code class="docutils literal notranslate"><span class="pre">fe</span></code> can be used to initialize the <a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.forms.html#shenfun.forms.arguments.Array">Array</a>
<code class="docutils literal notranslate"><span class="pre">fj</span></code>. We wrap this Numpy array in an <a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.forms.html#shenfun.forms.arguments.Array">Array</a> class
(<code class="docutils literal notranslate"><span class="pre">fj</span> <span class="pre">=</span> <span class="pre">Array(SD,</span> <span class="pre">buffer=fe)</span></code>), because an Array
is required as input to the <a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.forms.html#shenfun.forms.inner.inner">inner()</a> function.</p>
</div>
<div class="section" id="fix-boundary-conditions">
<h3>Fix boundary conditions<a class="headerlink" href="#fix-boundary-conditions" title="Permalink to this headline">¶</a></h3>
<p>Fiw two rows of the differentiation matrix in order to satisfy
Eqs. (<a class="reference external" href="#eq:dirichleta">4</a>) and (ref(eq:dirichletb)).</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="s1">&#39;lil&#39;</span><span class="p">)</span>
<span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
<span class="n">f_hat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ue</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">f_hat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ue</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the last two lines uses evaluation of the sympy function
<code class="docutils literal notranslate"><span class="pre">ue</span></code> at the borders of the domain. Implemented like this it is
easy to change to a nonstandard domain size.</p>
</div>
<div class="section" id="solve-linear-equations">
<h3>Solve linear equations<a class="headerlink" href="#solve-linear-equations" title="Permalink to this headline">¶</a></h3>
<p>Finally, solve linear equation system and transform solution from spectral
<span class="math notranslate nohighlight">\(\{\hat{u}_k\}_{k=0}^{N-1}\)</span> vector to the real space <span class="math notranslate nohighlight">\(\{u(x_j)\}_{j=0}^{N-1}\)</span>
and then check how the solution corresponds with the exact solution <span class="math notranslate nohighlight">\(u_e\)</span>.
To this end we compute the <span class="math notranslate nohighlight">\(L_2\)</span>-errornorm using the <code class="docutils literal notranslate"><span class="pre">shenfun</span></code> function
<a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.utilities.html#shenfun.utilities.dx">dx()</a></p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">u_hat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">scp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">f_hat</span><span class="p">)</span>
<span class="n">uj</span> <span class="o">=</span> <span class="n">u_hat</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">ua</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">ue</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error=</span><span class="si">%2.16e</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="p">((</span><span class="n">uj</span><span class="o">-</span><span class="n">ua</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="convergence-test">
<h3>Convergence test<a class="headerlink" href="#convergence-test" title="Permalink to this headline">¶</a></h3>
<p>To do a convergence test we will now create a function <code class="docutils literal notranslate"><span class="pre">main</span></code>, that takes the
number of quadrature points as parameter, and prints out
the error.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Chebyshev&#39;</span><span class="p">):</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">family</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Get f on quad points</span>
    <span class="n">fj</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">fe</span><span class="p">)</span>

    <span class="c1"># Compute right hand side of Poisson&#39;s equation</span>
    <span class="n">f_hat</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">f_hat</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">fj</span><span class="p">,</span> <span class="n">output_array</span><span class="o">=</span><span class="n">f_hat</span><span class="p">)</span>

    <span class="c1"># Get left hand side of Poisson&#39;s equation</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">div</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="s1">&#39;lil&#39;</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
    <span class="n">f_hat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ue</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f_hat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ue</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">u_hat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">scp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">f_hat</span><span class="p">)</span>
    <span class="n">uj</span> <span class="o">=</span> <span class="n">u_hat</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="c1"># Compare with analytical solution</span>
    <span class="n">ua</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">ue</span><span class="p">)</span>
    <span class="n">l2_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">uj</span><span class="o">-</span><span class="n">ua</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l2_error</span>
</pre></div>
</div>
</div>
</div>
<p>For example, we find the error of a Chebyshev discretization
using 12 quadrature points as</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;Chebyshev&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To get the convergence we call <code class="docutils literal notranslate"><span class="pre">main</span></code> for a list
of <span class="math notranslate nohighlight">\(N=[12, 16, \ldots, 48]\)</span>, and collect the errornorms in
arrays to be plotted. The error can be plotted using
<a class="reference external" href="https://matplotlib.org">matplotlib</a>, and the generated
figure is also shown in this demos summary.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">N</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">basis</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;legendre&#39;</span><span class="p">,</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">):</span>
    <span class="n">error</span><span class="p">[</span><span class="n">basis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
        <span class="n">errN</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">basis</span><span class="p">)</span>
        <span class="n">error</span><span class="p">[</span><span class="n">basis</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errN</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">basis</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;legendre&#39;</span><span class="p">,</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">error</span><span class="p">[</span><span class="n">basis</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergence of Tau Poisson solvers 1D&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Error norm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Legendre&#39;</span><span class="p">,</span> <span class="s1">&#39;Chebyshev&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The spectral convergence is evident and we can see that
after <span class="math notranslate nohighlight">\(N=40\)</span> roundoff errors dominate as the errornorm trails off around <span class="math notranslate nohighlight">\(10^{-14}\)</span>.</p>
</div>
</div>
<div class="section" id="complete-solver">
<h2>Complete solver<a class="headerlink" href="#complete-solver" title="Permalink to this headline">¶</a></h2>
<p><a id="sec:complete"></a></p>
<p>A complete solver, that can use either Legendre or Chebyshev bases, chosen as a
command-line argument, can also be found <a class="reference external" href="https://github.com/spectralDNS/shenfun/blob/master/demo/poisson1D_tau.py">here</a>.</p>
<!-- ======= Bibliography ======= --></div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "mikaem/shenfun-demos",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Mikael Mortensen<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>