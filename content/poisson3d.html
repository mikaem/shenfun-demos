

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Demo - 3D Poissonâ€™s equation &#8212; Shenfun executable demos</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "mikaem/shenfun-demos");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ðŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"TeX": {"Macros": {"bmat": ["\\left[\\begin{array}"], "emat": ["\\end{array}\\right]"]}, "extensions": ["cancel.js", "AMSmath.js"]}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/poisson3d';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Demo - Helmholtz equation in polar coordinates" href="polarhelmholtz.html" />
    <link rel="prev" title="Demo - Cubic nonlinear Klein-Gordon equation" href="kleingordon.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/seashell3.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/seashell3.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Shenfun executable demos
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Shenfun executable demos</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="poisson.html">Demo - 1D Poissonâ€™s equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="kleingordon.html">Demo - Cubic nonlinear Klein-Gordon equation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Demo - 3D Poissonâ€™s equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="polarhelmholtz.html">Demo - Helmholtz equation in polar coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphericalhelmholtz.html">Demo - Helmholtz equation on the unit sphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="kuramatosivashinsky.html">Demo - Kuramato-Sivashinsky equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="stokes.html">Demo - Stokes equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="drivencavity.html">Demo - Lid driven cavity</a></li>
<li class="toctree-l1"><a class="reference internal" href="rayleighbenard.html">Demo - Rayleigh Benard</a></li>
<li class="toctree-l1"><a class="reference internal" href="functions.html">Demo - Working with Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="surfaceintegration.html">Demo - Integration of functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="moebius.html">Demo - Eigenvalues on the MÃ¶bius strip</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixingbases.html">Demo - Mixed bases for the Helmholtz problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="tau.html">Demo - The Tau method</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparsity.html">Demo - Sparse Chebyshev-Petrov-Galerkin methods for differentiation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/mikaem/shenfun-demos/master?urlpath=tree/content/poisson3d.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>



<a href="https://github.com/mikaem/shenfun-demos" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/poisson3d.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Demo - 3D Poissonâ€™s equation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-s-equation">Poissonâ€™s equation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-of-manufactured-solutions">Method of manufactured solutions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#manufactured-solution">Manufactured solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discretization-and-mpi">Discretization and MPI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variational-formulation">Variational formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-linear-equations">Solve linear equations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-test">Convergence test</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-solver">Complete solver</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <!-- File automatically generated using DocOnce (https://github.com/doconce/doconce/):
doconce format ipynb poisson3d.do.txt  -->
<section class="tex2jax_ignore mathjax_ignore" id="demo-3d-poisson-s-equation">
<h1>Demo - 3D Poissonâ€™s equation<a class="headerlink" href="#demo-3d-poisson-s-equation" title="Permalink to this heading">#</a></h1>
<p><strong>Mikael Mortensen</strong> (email: <code class="docutils literal notranslate"><span class="pre">mikaem&#64;math.uio.no</span></code>), Department of Mathematics, University of Oslo.</p>
<p>Date: <strong>April 13, 2018</strong></p>
<p><strong>Summary.</strong> This is a demonstration of how the Python module <a class="reference external" href="https://github.com/spectralDNS/shenfun">shenfun</a> can be used to solve a 3D Poisson
equation in a 3D tensor product domain that has homogeneous Dirichlet boundary
conditions in one direction and periodicity in the
remaining two. The solver described runs with MPI without any further
considerations required from the user. Spectral convergence, as shown in <span class="xref myst">Figure 1</span>, is demonstrated.
The demo is implemented in slightly more generic terms (more boundary conditions) in
<a class="reference external" href="https://github.com/spectralDNS/shenfun/blob/master/demo/poisson3D.py">poisson3D.py</a>, and the numerical method is is described in more detail by J. Shen <span class="xref myst">[shen1]</span> and <span class="xref myst">[shen95]</span>.</p>
<!-- dom:FIGURE: [https://rawgit.com/spectralDNS/spectralutilities/master/figures/poisson3D_errornorm.png] Convergence of 3D Poisson solvers for both Legendre and Chebyshev modified basis function. <a id="fig:3d:ct0"></a> -->
<!-- begin figure -->
<p><a id="fig:3d:ct0"></a></p>
<p><img src="https://rawgit.com/spectralDNS/spectralutilities/master/figures/poisson3D_errornorm.png" ><p style="font-size: 0.9em"><i>Figure 1: Convergence of 3D Poisson solvers for both Legendre and Chebyshev modified basis function.</i></p></p>
<!-- end figure --><section id="poisson-s-equation">
<h2>Poissonâ€™s equation<a class="headerlink" href="#poisson-s-equation" title="Permalink to this heading">#</a></h2>
<p><a id="demo:poisson3d"></a></p>
<p>Poissonâ€™s equation is given as</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:3d:poisson"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\nabla^2 u(\boldsymbol{x}) = f(\boldsymbol{x}) \quad \text{for }\, \boldsymbol{x}=(x, y, z) \in \Omega, \label{eq:3d:poisson} \tag{1}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto1"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
u(\pm 1 ,y, z) =0, 
\label{_auto1} \tag{2}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto2"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
u(x, 2\pi, z) = u(x, 0, z), 
\label{_auto2} \tag{3}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto3"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
u(x, y, 2\pi) = u(x, y, 0),
\label{_auto3} \tag{4}
\end{equation}
\]</div>
<p>where <span class="math notranslate nohighlight">\(u(\boldsymbol{x})\)</span> is the solution and <span class="math notranslate nohighlight">\(f(\boldsymbol{x})\)</span> is a function. The domain
<span class="math notranslate nohighlight">\(\Omega = [-1, 1]\times [0, 2\pi]^2\)</span>.</p>
<p>To solve Eq. (<span class="xref myst">1</span>) with the Galerkin method we will make use of
smooth basis functions, <span class="math notranslate nohighlight">\(v(\boldsymbol{x})\)</span>, that satisfy the given boundary
conditions. To this end we will use one basis function for the <span class="math notranslate nohighlight">\(x\)</span>-direction,
<span class="math notranslate nohighlight">\(\mathcal{X}(x)\)</span>,
one for the <span class="math notranslate nohighlight">\(y\)</span>-direction, <span class="math notranslate nohighlight">\(\mathcal{Y}(y)\)</span>, and one for the <span class="math notranslate nohighlight">\(z\)</span>-direction,
<span class="math notranslate nohighlight">\(\mathcal{Z}(z)\)</span>. And
then we create three-dimensional basis functions like</p>
<div class="math notranslate nohighlight">
\[
v(x, y, z) = \mathcal{X}(x) \mathcal{Y}(y) \mathcal{Z} (z).
\]</div>
<p>The basis functions <span class="math notranslate nohighlight">\(\mathcal{Y}(y)\)</span> and <span class="math notranslate nohighlight">\(\mathcal{Z}(z)\)</span> are chosen as Fourier exponentials, since these
functions are periodic. Likewise, the basis functions <span class="math notranslate nohighlight">\(\mathcal{X}(x)\)</span> are chosen as
modified Legendre or Chebyshev polynomials, using <span class="math notranslate nohighlight">\(\phi_l(x)\)</span> to refer to either
one</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto4"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\mathcal{X}_l(x) = \phi_l(x) - \phi_{l+2}(x), \forall \, l \in \boldsymbol{l}^{N_0},
\label{_auto4} \tag{5}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto5"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
\mathcal{Y}_m(y) =  e^{\imath m y}, \forall \, m \in \boldsymbol{m}^{N_1}, 
\label{_auto5} \tag{6}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto6"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
\mathcal{Z}_n(z) = e^{\imath n z}, \forall \, n \in \boldsymbol{n}^{N_2},
\label{_auto6} \tag{7}
\end{equation}
\]</div>
<p>where the size of the discretized problem is <span class="math notranslate nohighlight">\(\boldsymbol{N} = (N_0, N_1, N_2)\)</span>,
<span class="math notranslate nohighlight">\(\boldsymbol{l}^{N_0} = (0, 1, \ldots, N_0-3)\)</span>, <span class="math notranslate nohighlight">\(\boldsymbol{m}^{N_1} =
(-N_1/2, -N_1/2+1, \ldots, N_1/2-1)\)</span> and <span class="math notranslate nohighlight">\(\boldsymbol{n}^{N_2} = (-N_2/2, -N_2/2+1,
\ldots, N_2/2-1)\)</span>. However, due to <a class="reference external" href="https://docs.scipy.org/doc/numpy-1.13.0/reference/generated/numpy.fft.rfft.html#numpy.fft.rfft">Hermitian symmetry</a>, we only store <span class="math notranslate nohighlight">\(N_2/2+1\)</span>
wavenumbers in the <span class="math notranslate nohighlight">\(z\)</span>-direction, such that <span class="math notranslate nohighlight">\(\boldsymbol{n}^{N_2} = (0, 1, \ldots,
N_2/2)\)</span>. We refer to the Cartesian wavenumber mesh on vector form as <span class="math notranslate nohighlight">\(\boldsymbol{k}\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{k} = \{(l, m, n)\, | \,(l, m, n)  \in \boldsymbol{l}^{N_0} \times \boldsymbol{m}^{N_1} \times \boldsymbol{n}^{N_2}\}.
\]</div>
<p>We have the one-dimensional spaces</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto7"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
V^{N_0} = \text{span}\{ \mathcal{X}_l \}_{l\in\boldsymbol{l}^{N_0}}, 
\label{_auto7} \tag{8}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto8"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
V^{N_1} = \text{span}\{ \mathcal{Y}_m \}_{m\in\boldsymbol{m}^{N_1}}, 
\label{_auto8} \tag{9}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto9"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
V^{N_2} = \text{span}\{ \mathcal{Z}_n \}_{n\in\boldsymbol{n}^{N_2}},
\label{_auto9} \tag{10}
\end{equation}
\]</div>
<p>and from these we create a tensor product space <span class="math notranslate nohighlight">\(W^{\boldsymbol{N}}(\boldsymbol{x})\)</span></p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto10"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
W^{\boldsymbol{N}}(\boldsymbol{x}) = V^{N_0}(x) \otimes V^{N_1}(y) \otimes V^{N_2}(z).
\label{_auto10} \tag{11}
\end{equation}
\]</div>
<p>And then we look for discrete solutions <span class="math notranslate nohighlight">\(u \in W^{\boldsymbol{N}}\)</span> like</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:3d:u"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
u(\boldsymbol{x}) = \sum_{l\in \boldsymbol{l}^{N_0}} \sum_{m\in \boldsymbol{m}^{N_1}}\sum_{n\in
\boldsymbol{n}^{N_2}}\hat{u}_{lmn} \mathcal{X}_l(x) \mathcal{Y}_m(y) \mathcal{Z}_n(z), \label{eq:3d:u} \tag{12} 
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="_auto11"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}  
 = \sum_{\boldsymbol{\textsf{k}} \in \boldsymbol{k}}\hat{u}_{\boldsymbol{\textsf{k}}} v_{\boldsymbol{\textsf{k}}}(\boldsymbol{x}),
\label{_auto11} \tag{13}
\end{equation}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{u}_{lmn}\)</span> are components of the expansion coefficients for <span class="math notranslate nohighlight">\(u\)</span> and
the second form, <span class="math notranslate nohighlight">\(\{\hat{u}_{\boldsymbol{\textsf{k}}}\}_{\boldsymbol{\textsf{k}}\in\boldsymbol{k}}\)</span>, is a shorter,
simplified notation, with sans-serif <span class="math notranslate nohighlight">\(\boldsymbol{\textsf{k}}=(l, m, n)\)</span>.
The expansion coefficients are the unknowns in the spectral Galerkin method.</p>
<p>We now formulate a variational problem using the Galerkin method: Find <span class="math notranslate nohighlight">\(u \in
W^{\boldsymbol{N}}\)</span> such that</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:3d:varform"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\int_{\Omega} \nabla^2 u \, \overline{v} \, w\, \boldsymbol{dx} = \int_{\Omega} f \,
\overline{v}\, w\, \boldsymbol{dx} \quad
\forall v \, \in \, W^{\boldsymbol{N}}. \label{eq:3d:varform} \tag{14}
\end{equation}
\]</div>
<p>Here <span class="math notranslate nohighlight">\(\boldsymbol{dx}=dxdydz\)</span>, and the overline represents a complex conjugate, which is needed here because
the Fourier exponentials are complex functions.
The weighted integrals, weighted by <span class="math notranslate nohighlight">\(w(\boldsymbol{x})\)</span>, are called inner products, and a common notation is</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto12"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\int_{\Omega} u \, \overline{v} \, w\, \boldsymbol{dx} = \langle u, v\rangle _w.
\label{_auto12} \tag{15}
\end{equation}
\]</div>
<p>The integral can either be computed exactly, or with quadrature. The advantage
of the latter is that it is faster (through Fast Fourier transforms),
and that non-linear terms may be computed just as quickly as linear.
For a linear problem, it does not make much of a difference, if any at all.
Approximating the integral with quadrature, we obtain</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\int_{\Omega} u \, \overline{v} \, w\, \boldsymbol{dx} &amp;\approx \langle u, v
\rangle_w^{\boldsymbol{N}},  \\ 
&amp;\approx \sum_{i=0}^{N_0-1} \sum_{j=0}^{N_1-1}\sum_{k=0}^{N_2-1} u(x_i, y_j, z_k) \overline{v}(x_i, y_j, z_k) w(x_i, y_j, z_k),
\end{align*}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(w(\boldsymbol{x})\)</span> now are the quadrature weights. The quadrature points
<span class="math notranslate nohighlight">\(\{x_i\}_{i=0}^{N_0-1}\)</span> are specific to the chosen basis, and even within basis there
are two different choices based on which quadrature rule is selected, either
Gauss or Gauss-Lobatto. The quadrature points for the Fourier bases are simply
uniformly distributed throughout the domain.</p>
<p>Inserting for test function (<span class="xref myst">12</span>) and trialfunction
<span class="math notranslate nohighlight">\(v_{pqr} = \mathcal{X}_{p} \mathcal{Y}_q \mathcal{Z}_r\)</span> on the
left hand side of (<span class="xref myst">14</span>), we get (with summation on repeated indices
to avoid too much clutter)</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\langle \nabla^2u, v \rangle_w^{\boldsymbol{N}} &amp;= \left\langle \nabla^2\sum_{l\in \boldsymbol{l}^{N_0}}
\sum_{m\in \boldsymbol{m}^{N_1}}\sum_{n\in \boldsymbol{n}^{N_2}}\hat{u}_{lmn}
\mathcal{X}_{l} \mathcal{Y}_m \mathcal{Z}_n,
\mathcal{X}_{p} \mathcal{Y}_q \mathcal{Z}_r \right\rangle_w^{\boldsymbol{N}}, \\ 
    &amp;= \left[\left(\mathcal{X}_l^{''}, \mathcal{X}_p \right)_w^N - (m^2+n^2)\left(\mathcal{X}_l, \mathcal{X}_p \right)_w^N  \right]\delta_{mq} \delta_{nr} \hat{u}_{lmn}, \\ 
    &amp;= \left( a_{pl} - (m^2 + n^2)b_{pl}\right) \hat{u}_{lqr}, \quad \forall (p,q,r) \in \boldsymbol{k},
\end{align*}
\end{split}\]</div>
<p>where the notation <span class="math notranslate nohighlight">\((\cdot, \cdot)_w^{N_0}\)</span></p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto13"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
b_{pl} = \left( \mathcal{X}_l, \mathcal{X}_p \right)_w^{N_0} = \sum_{i=0}^{N_0-1} \mathcal{X}_l(x_i)
\mathcal{X}_p(x_i) w(x_i),
\label{_auto13} \tag{16}
\end{equation}
\]</div>
<p>is used to represent a discrete <span class="math notranslate nohighlight">\(L_2\)</span> inner product along only the first, nonperiodic,
direction. The delta functions above come from integrating over the two periodic
directions, where we use constant weight functions <span class="math notranslate nohighlight">\(w=1/(2\pi)\)</span> in the
inner products</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:delta0"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\int_0^{2\pi} \mathcal{Y}_m(y) \overline{\mathcal{Y}}_q(y) \frac{1}{2\pi} dy = \delta_{mq}, \label{eq:delta0} \tag{17}
\end{equation}
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="eq:delta1"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\int_0^{2\pi} \mathcal{Z}_n(z) \overline{\mathcal{Z}}_r(z) \frac{1}{2\pi} dz = \delta_{nr}. \label{eq:delta1} \tag{18}
\end{equation}
\]</div>
<p>The Kronecker delta-function <span class="math notranslate nohighlight">\(\delta_{ij}\)</span> is one for <span class="math notranslate nohighlight">\(i=j\)</span> and
zero otherwise.</p>
<p>The right hand side of Eq. (<span class="xref myst">14</span>) is computed as</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto14"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\tilde{f}_{pqr} = \left\langle f, \mathcal{X}_{p}
\mathcal{Y}_q \mathcal{Z}_r  \right \rangle_w^{\boldsymbol{N}},
\label{_auto14} \tag{19}
\end{equation}
\]</div>
<p>where a tilde is used because this is not a complete transform of the function
<span class="math notranslate nohighlight">\(f\)</span>, but only an inner product.</p>
<p>The linear system of equations to solve for the expansion coefficients can now
be found as follows</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:AB"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\left(a_{lp} - (m^2+n^2)b_{lp}\right) \hat{u}_{pmn} =
\tilde{f}_{lmn}\quad \forall \, (l,m,n) \in \boldsymbol{k}. \label{eq:AB} \tag{20}
\end{equation}
\]</div>
<p>Now, when <span class="math notranslate nohighlight">\(\hat{\boldsymbol{u}} = \{\hat{u}_{\boldsymbol{\textsf{k}}}\}_{\boldsymbol{\textsf{k}} \in \boldsymbol{k}}\)</span> is
found by solving this linear system over the
entire computational mesh, it may be
transformed to real space <span class="math notranslate nohighlight">\(u(\boldsymbol{x})\)</span> using (<span class="xref myst">12</span>). Note that the matrices
<span class="math notranslate nohighlight">\(A \in \mathbb{R}^{N_0-2 \times N_0-2}\)</span> and <span class="math notranslate nohighlight">\(B \in \mathbb{R}^{N_0-2 \times N_0-2}\)</span>
differ for Legendre or Chebyshev bases, but
for either case they have a
special structure that allows for a solution to be found very efficiently
in the order of <span class="math notranslate nohighlight">\(\mathcal{O}(N_0-3)\)</span> operations given <span class="math notranslate nohighlight">\(m\)</span> and <span class="math notranslate nohighlight">\(n\)</span>, see
<span class="xref myst">[shen1]</span> and <span class="xref myst">[shen95]</span>. Fast solvers for (<span class="xref myst">20</span>) are implemented in <code class="docutils literal notranslate"><span class="pre">shenfun</span></code> for both bases.</p>
<section id="method-of-manufactured-solutions">
<h3>Method of manufactured solutions<a class="headerlink" href="#method-of-manufactured-solutions" title="Permalink to this heading">#</a></h3>
<p>In this demo we will use the method of manufactured
solutions to demonstrate spectral accuracy of the <code class="docutils literal notranslate"><span class="pre">shenfun</span></code> bases. To
this end we choose a smooth analytical function that satisfies the given boundary
conditions:</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:3d:u_e"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
u_e(x, y, z) = \left(\cos(4x) + \sin(2y) + \sin(4z)\right)(1-x^2). \label{eq:3d:u_e} \tag{21}
\end{equation}
\]</div>
<p>Sending <span class="math notranslate nohighlight">\(u_e\)</span> through the Laplace operator, we obtain the right hand side</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:3d:solution"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
 \nabla^2 u_e(x,y,z) = -16(1 - x^2) \cos(4 x) + 16 x \sin(4 x) - 2 \cos(4 x)
                  - (1-x^2)(4 \sin(2y) + 16\sin(4z)).  \label{eq:3d:solution} \tag{22}
\end{equation}
\]</div>
<p>Now, setting <span class="math notranslate nohighlight">\(f_e(\boldsymbol{x}) = \nabla^2 u_e(\boldsymbol{x})\)</span> and solving for <span class="math notranslate nohighlight">\(\nabla^2
u(\boldsymbol{x}) = f_e(\boldsymbol{x})\)</span>, we can compare the numerical solution <span class="math notranslate nohighlight">\(u(\boldsymbol{x})\)</span> with
the analytical solution <span class="math notranslate nohighlight">\(u_e(\boldsymbol{x})\)</span> and compute error norms.</p>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">#</a></h2>
<section id="preamble">
<h3>Preamble<a class="headerlink" href="#preamble" title="Permalink to this heading">#</a></h3>
<p>We will solve the Poisson problem using the <a class="reference external" href="https://github.com/spectralDNS/shenfun">shenfun</a> Python module. The first thing needed
is then to import some of this moduleâ€™s functionality
plus some other helper modules, like <a class="reference external" href="https://numpy.org">Numpy</a> and <a class="reference external" href="https://sympy.org">Sympy</a>:</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">lambdify</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">shenfun.tensorproductspace</span> <span class="kn">import</span> <span class="n">TensorProductSpace</span>
<span class="kn">from</span> <span class="nn">shenfun</span> <span class="kn">import</span> <span class="n">inner</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">TestFunction</span><span class="p">,</span> <span class="n">TrialFunction</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> \
    <span class="n">project</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">FunctionSpace</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">Array</span><span class="p">,</span> <span class="n">chebyshev</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">la</span>
</pre></div>
</div>
</div>
</div>
<p>We use <code class="docutils literal notranslate"><span class="pre">Sympy</span></code> for the manufactured solution and <code class="docutils literal notranslate"><span class="pre">Numpy</span></code> for testing. MPI for
Python (<code class="docutils literal notranslate"><span class="pre">mpi4py</span></code>) is required for running the solver with MPI.</p>
</section>
<section id="manufactured-solution">
<h3>Manufactured solution<a class="headerlink" href="#manufactured-solution" title="Permalink to this heading">#</a></h3>
<p>The exact solution <span class="math notranslate nohighlight">\(u_e(x, y, z)\)</span> and the right hand side <span class="math notranslate nohighlight">\(f_e(x, y, z)\)</span> are created using <code class="docutils literal notranslate"><span class="pre">Sympy</span></code> as follows</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;x,y,z&quot;</span><span class="p">)</span>
<span class="n">ue</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fe</span> <span class="o">=</span> <span class="n">ue</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ue</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ue</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These solutions are now valid for a continuous domain. The next step is thus to
discretize, using the computational mesh</p>
<div class="math notranslate nohighlight">
\[
(x_i, y_j, z_k)\, \forall \, (i, j, k) \in [0, 1,\ldots, N_0-1] \times [0, 1, \ldots, N_1-1] \times [0, 1, \ldots, N_2-1]
\]</div>
<p>and a finite number of basis functions.</p>
<p>Note that it is not mandatory to use <code class="docutils literal notranslate"><span class="pre">Sympy</span></code> for the manufactured solution. Since the
solution is known (<span class="xref myst">22</span>), we could just as well simply use <code class="docutils literal notranslate"><span class="pre">Numpy</span></code>
to compute <span class="math notranslate nohighlight">\(f_e\)</span>. However, with <code class="docutils literal notranslate"><span class="pre">Sympy</span></code> it is much
easier to experiment and quickly change the solution.</p>
</section>
<section id="discretization-and-mpi">
<h3>Discretization and MPI<a class="headerlink" href="#discretization-and-mpi" title="Permalink to this heading">#</a></h3>
<p>We create three function spaces with given size, one for each dimension of the problem.
From these three spaces a <a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.html#shenfun.tensorproductspace.TensorProductSpace">TensorProductSpace</a> is created.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Size of discretization</span>
<span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>

<span class="n">SD</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Chebyshev&#39;</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="c1">#SD = FunctionSpace(N[0], &#39;Legendre&#39;, bc=(0, 0))</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Fourier&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;Fourier&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">TensorProductSpace</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="p">(</span><span class="n">SD</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">local_mesh</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we can either choose a Legendre or a Chebyshev basis for the
nonperiodic direction. The
<a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.html#shenfun.tensorproductspace.TensorProductSpace">TensorProductSpace</a> class takes an MPI communicator as first argument and the
computational mesh is distributed internally using the <code class="docutils literal notranslate"><span class="pre">pencil</span></code> method. The
<code class="docutils literal notranslate"><span class="pre">T.local_mesh</span></code> method returns the mesh local to each processor. The <code class="docutils literal notranslate"><span class="pre">axes</span></code>
keyword determines the order of transforms going back and forth between real and
spectral space. With <code class="docutils literal notranslate"><span class="pre">axes=(0,</span> <span class="pre">1,</span> <span class="pre">2)</span></code> and a forward transform (from real space
to spectral, i.e., from <span class="math notranslate nohighlight">\(u\)</span> to <span class="math notranslate nohighlight">\(\hat{u}\)</span>) axis 2 is transformed first and then 1
and 0, respectively.</p>
<p>The manufactured solution is created with Dirichlet boundary conditions in the
<span class="math notranslate nohighlight">\(x\)</span>-direction, and for this reason <code class="docutils literal notranslate"><span class="pre">SD</span></code> is the first space in <code class="docutils literal notranslate"><span class="pre">T</span></code>. We could just
as well have put the nonperiodic direction along either <span class="math notranslate nohighlight">\(y\)</span>- or <span class="math notranslate nohighlight">\(z\)</span>-direction,
though, but this would then require that the order of the transformed axes be
changed as well. For example, putting the Dirichlet direction along <span class="math notranslate nohighlight">\(y\)</span>, we
would need to create the tensorproductspace as</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span>        <span class="n">T</span> <span class="o">=</span> <span class="n">TensorProductSpace</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="p">(</span><span class="n">K1</span><span class="p">,</span> <span class="n">SD</span><span class="p">,</span> <span class="n">K2</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>such that the Dirichlet direction is the last to be transformed. The reason for
this is that only the Dirichlet direction leads to matrices that need to be
inverted (or solved). And for this we need the entire data array along the Dirichlet
direction to be local to the processor. If the <code class="docutils literal notranslate"><span class="pre">SD</span></code> basis is the last to be
transformed, then the data will be aligned in this direction, whereas the other
two directions may both, or just one of them, be distributed.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">X</span></code> is a list containing local values of the arrays <span class="math notranslate nohighlight">\(\{x_i\}_{i=0}^{N_0-1}\)</span>,
<span class="math notranslate nohighlight">\(\{y_j\}_{j=0}^{N_1-1}\)</span> and <span class="math notranslate nohighlight">\(\{z_k\}_{k=0}^{N_2-1}\)</span>.
Now, itâ€™s not possible to run a jupyter notebook with more than one process,
but we can imagine running <a class="reference external" href="https://github.com/spectralDNS/shenfun/blob/master/demo/poisson3D.py">the complete solver</a>
with 4 procesors and a processor mesh of shape <span class="math notranslate nohighlight">\(2\times 2\)</span>.
We would then get the following local slices for
each processor in spectral space</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span>        <span class="nb">print</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">(),</span> <span class="n">T</span><span class="o">.</span><span class="n">local_slice</span><span class="p">())</span>
        <span class="mi">3</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="mi">1</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="mi">2</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="mi">0</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
</pre></div>
</div>
<p>where the global shape is <span class="math notranslate nohighlight">\(\boldsymbol{N}=(14, 15, 9)\)</span> after taking advantage of
Hermitian symmetry in the <span class="math notranslate nohighlight">\(z\)</span>-direction. So, all processors have the complete first dimension available locally, as they
should. Furthermore, processor three owns the slices from <span class="math notranslate nohighlight">\(8:15\)</span> and <span class="math notranslate nohighlight">\(5:9\)</span> along
axes <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span>, respectively. Processor 2 owns slices <span class="math notranslate nohighlight">\(0:8\)</span> and <span class="math notranslate nohighlight">\(0:5\)</span> etc. In
real space the mesh is distributed differently. First of all the global mesh
shape is <span class="math notranslate nohighlight">\(\boldsymbol{N}=(14, 15, 16)\)</span>, and it is distributed along the first two
dimensions. The local slices can be inspected as</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span>        <span class="nb">print</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">(),</span> <span class="n">T</span><span class="o">.</span><span class="n">local_slice</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
        <span class="mi">0</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="mi">1</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="mi">2</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="mi">3</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
</pre></div>
</div>
<p>Since two directions are distributed, both in spectral and real space, we say
that we have a two-dimensional decomposition (here a <span class="math notranslate nohighlight">\(2\times 2\)</span> shaped
processor mesh) and the
MPI distribution is of type <em>pencil</em>. It is also possible to choose a <em>slab</em>
decomposition, where only one dimension of the array is distributed. This choice
needs to be made when creating the tensorproductspace as</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span>        <span class="n">T</span> <span class="o">=</span> <span class="n">TensorProductSpace</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="p">(</span><span class="n">SD</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">slab</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>which would lead to a mesh that is distributed along <span class="math notranslate nohighlight">\(x\)</span>-direction in real space
and <span class="math notranslate nohighlight">\(y\)</span>-direction in spectral space. The local slices would then be</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    print(comm.Get_rank(), T.local_slice()) # spectral space
    1 [slice(0, 14, None), slice(4, 8, None), slice(0, 9, None)]
    2 [slice(0, 14, None), slice(8, 12, None), slice(0, 9, None)]
    0 [slice(0, 14, None), slice(0, 4, None), slice(0, 9, None)]
    3 [slice(0, 14, None), slice(12, 15, None), slice(0, 9, None)]
    print(comm.Get_rank(), T.local_slice(False)) # real space
    3 [slice(11, 14, None), slice(0, 15, None), slice(0, 16, None)]
    0 [slice(0, 4, None), slice(0, 15, None), slice(0, 16, None)]
    2 [slice(8, 11, None), slice(0, 15, None), slice(0, 16, None)]
    1 [slice(4, 8, None), slice(0, 15, None), slice(0, 16, None)]
</pre></div>
</div>
<p>Note that the <em>slab</em> decomposition is usually the fastest choice. However, the maximum
number of processors with <em>slab</em> is <span class="math notranslate nohighlight">\(\min \{N_0, N_1\}\)</span>, whereas a <em>pencil</em>
approach can be used with up to <span class="math notranslate nohighlight">\(\min \{N_1(N_2/2+1), N_0 N_1\}\)</span> processors.</p>
</section>
<section id="variational-formulation">
<h3>Variational formulation<a class="headerlink" href="#variational-formulation" title="Permalink to this heading">#</a></h3>
<p>The variational problem (<span class="xref myst">14</span>) can be assembled using <code class="docutils literal notranslate"><span class="pre">shenfun</span></code>â€™s
form language, which is perhaps surprisingly similar to FEniCS.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="c1"># Get f on quad points</span>
<span class="n">fj</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">fe</span><span class="p">)</span>
<span class="c1"># Compute right hand side of Poisson equation</span>
<span class="n">f_hat</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">fj</span><span class="p">)</span>
<span class="c1"># Get left hand side of Poisson equation</span>
<span class="n">matrices</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">div</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>The Laplacian operator is recognized as <code class="docutils literal notranslate"><span class="pre">div(grad)</span></code>. The <code class="docutils literal notranslate"><span class="pre">matrices</span></code> object is a
list of two tensor product matrices, stored as instances of the class <a class="reference external" href="https://shenfun.readthedocs.io/en/latest/shenfun.html#shenfun.matrixbase.TPMatrix">TPMatrix</a>.
The two tensor product matrices represents</p>
<div class="math notranslate nohighlight">
\[
a_{pl} \delta_{mq} \delta_{nr}\, \text{ and }\, -(m^2 + n^2)b_{pl} \delta_{mq} \delta_{nr}
\]</div>
<p>from Eqs. (<span class="xref myst">20</span>), (<span class="xref myst">17</span>) and (<span class="xref myst">18</span>).
The second matrix (<span class="math notranslate nohighlight">\(-(m^2 + n^2)b_{pl} \delta_{mq} \delta_{nr}\)</span>) has an
attribute <code class="docutils literal notranslate"><span class="pre">scale</span></code> that is equal to <span class="math notranslate nohighlight">\(-(m^2+n^2)\)</span>.
This <code class="docutils literal notranslate"><span class="pre">scale</span></code> is stored as a numpy array of shape <span class="math notranslate nohighlight">\((1, 15, 9)\)</span>, representing the set
<span class="math notranslate nohighlight">\(\{-(m^2+n^2): (m, n) \in \boldsymbol{m}^{N_1} \times \boldsymbol{n}^{N_2}\}\)</span>. Note that <span class="math notranslate nohighlight">\(\boldsymbol{n}^{N_2}\)</span> is stored
simply as an array of length <span class="math notranslate nohighlight">\(N_2/2+1\)</span> (here 9), since the transform in direction <span class="math notranslate nohighlight">\(z\)</span>
takes a real signal and transforms it taking advantage of Hermitian symmetry,
see <a class="reference external" href="https://docs.scipy.org/doc/numpy-1.13.0/reference/generated/numpy.fft.rfft.html">rfft</a>.</p>
</section>
<section id="solve-linear-equations">
<h3>Solve linear equations<a class="headerlink" href="#solve-linear-equations" title="Permalink to this heading">#</a></h3>
<p>Finally, solve linear equation system and transform solution from spectral
<span class="math notranslate nohighlight">\(\hat{u}_{\boldsymbol{\textsf{k}}}\)</span> vector to the real space <span class="math notranslate nohighlight">\(u(\boldsymbol{x})\)</span> and then check how the solution corresponds with the exact solution <span class="math notranslate nohighlight">\(u_e\)</span>.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create Helmholtz linear algebra solver</span>
<span class="n">Solver</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">Helmholtz</span>
<span class="c1">#Solver = la.SolverGeneric1ND # For Legendre</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">matrices</span><span class="p">)</span>

<span class="c1"># Solve and transform to real space</span>
<span class="n">u_hat</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>           <span class="c1"># Solution spectral space</span>
<span class="n">u_hat</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">u_hat</span><span class="p">,</span> <span class="n">f_hat</span><span class="p">)</span>       <span class="c1"># Solve</span>
<span class="n">uq</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">u_hat</span><span class="p">)</span>

<span class="c1"># Compare with analytical solution</span>
<span class="n">uj</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">ue</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">uj</span><span class="o">-</span><span class="n">uq</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error=</span><span class="si">%2.16e</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="convergence-test">
<h3>Convergence test<a class="headerlink" href="#convergence-test" title="Permalink to this heading">#</a></h3>
<p>To do a convergence test we will now create a function <code class="docutils literal notranslate"><span class="pre">main</span></code>, that takes the
number of quadrature points as parameter, and prints out
the error.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Chebyshev&#39;</span><span class="p">):</span>
    <span class="n">Solver</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">Helmholtz</span> <span class="k">if</span> <span class="n">family</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;chebyshev&#39;</span> <span class="k">else</span> <span class="n">la</span><span class="o">.</span><span class="n">SolverGeneric1ND</span>
    <span class="n">SD</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">family</span><span class="p">,</span> <span class="n">bc</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">K1</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="n">K2</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">TensorProductSpace</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="p">(</span><span class="n">SD</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Get f on quad points</span>
    <span class="n">fj</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">fe</span><span class="p">)</span>

    <span class="c1"># Compute right hand side of Poisson&#39;s equation</span>
    <span class="n">f_hat</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">f_hat</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">fj</span><span class="p">,</span> <span class="n">output_array</span><span class="o">=</span><span class="n">f_hat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">family</span> <span class="o">==</span> <span class="s1">&#39;legendre&#39;</span><span class="p">:</span>
        <span class="n">f_hat</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.</span>

    <span class="c1"># Get left hand side of Poisson equation</span>
    <span class="k">if</span> <span class="n">family</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">:</span>
        <span class="n">matrices</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">div</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">matrices</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>

    <span class="c1"># Create Helmholtz linear algebra solver</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">(</span><span class="n">matrices</span><span class="p">)</span>

    <span class="c1"># Solve and transform to real space</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>           <span class="c1"># Solution spectral space</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">f_hat</span><span class="p">,</span> <span class="n">u_hat</span><span class="p">)</span>       <span class="c1"># Solve</span>

    <span class="n">uj</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">uj</span> <span class="o">=</span> <span class="n">u_hat</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">uj</span><span class="p">)</span>

    <span class="c1"># Compare with analytical solution</span>
    <span class="n">ua</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">ue</span><span class="p">)</span>
    <span class="c1">#l2_error = np.linalg.norm(uj-ua)</span>
    <span class="n">L2_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="p">((</span><span class="n">uj</span><span class="o">-</span><span class="n">ua</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">L2_error</span>
</pre></div>
</div>
</div>
</div>
<p>For example, we find the error of a Chebyshev discretization
using 12 quadrature points as</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">main</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;Chebyshev&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To get the convergence we call <code class="docutils literal notranslate"><span class="pre">main</span></code> for a list
of <span class="math notranslate nohighlight">\(N=[12, 16, \ldots, 48]\)</span>, and collect the errornorms in
arrays to be plotted. The error can be plotted using
<a class="reference external" href="https://matplotlib.org">matplotlib</a>, and the generated
figure is also shown in this demos summary.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">N</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">basis</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;legendre&#39;</span><span class="p">,</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">):</span>
    <span class="n">error</span><span class="p">[</span><span class="n">basis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
        <span class="n">errN</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">basis</span><span class="p">)</span>
        <span class="n">error</span><span class="p">[</span><span class="n">basis</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errN</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">basis</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;legendre&#39;</span><span class="p">,</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">error</span><span class="p">[</span><span class="n">basis</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergence of Poisson solvers 1D&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Error norm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Legendre&#39;</span><span class="p">,</span> <span class="s1">&#39;Chebyshev&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The spectral convergence is evident and we can see that
after <span class="math notranslate nohighlight">\(N=24\)</span> roundoff errors dominate as the errornorm trails off around <span class="math notranslate nohighlight">\(10^{-14}\)</span>.</p>
</section>
</section>
<section id="complete-solver">
<h2>Complete solver<a class="headerlink" href="#complete-solver" title="Permalink to this heading">#</a></h2>
<p><a id="sec:complete"></a></p>
<p>A complete solver, that can use any family of bases (Chebyshev, Legendre, Jacobi, Chebyshev second kind),
and any kind of boundary condition, can be found <a class="reference external" href="https://github.com/spectralDNS/shenfun/blob/master/demo/poisson3D.py">here</a>.</p>
<!-- ======= Bibliography ======= -->
<ol class="arabic simple">
<li><p><a id="shen1"></a> <strong>J. Shen</strong>.  Efficient Spectral-Galerkin Method I. Direct Solvers of Second- and Fourth-Order Equations Using Legendre Polynomials, <em>SIAM Journal on Scientific Computing</em>, 15(6), pp. 1489-1505, <a class="reference external" href="https://dx.doi.org/10.1137/0915089">doi: 10.1137/0915089</a>, 1994.</p></li>
<li><p><a id="shen95"></a> <strong>J. Shen</strong>.  Efficient Spectral-Galerkin Method II. Direct Solvers of Second- and Fourth-Order Equations Using Chebyshev Polynomials, <em>SIAM Journal on Scientific Computing</em>, 16(1), pp. 74-87, <a class="reference external" href="https://dx.doi.org/10.1137/0916006">doi: 10.1137/0916006</a>, 1995.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "mikaem/shenfun-demos",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="kleingordon.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Demo - Cubic nonlinear Klein-Gordon equation</p>
      </div>
    </a>
    <a class="right-next"
       href="polarhelmholtz.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Demo - Helmholtz equation in polar coordinates</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-s-equation">Poissonâ€™s equation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-of-manufactured-solutions">Method of manufactured solutions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#manufactured-solution">Manufactured solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discretization-and-mpi">Discretization and MPI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variational-formulation">Variational formulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-linear-equations">Solve linear equations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-test">Convergence test</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-solver">Complete solver</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mikael Mortensen
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>