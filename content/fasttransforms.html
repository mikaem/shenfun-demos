

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo - Some fast transforms &#8212; Shenfun executable demos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/mystnb.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"bmat": ["\\left[\\begin{array}"], "emat": ["\\end{array}\\right]"]}, "extensions": ["cancel.js", "AMSmath.js"]}})</script>
    <script async="async" src="https://unpkg.com/thebe-mikaem/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Demo - Mixed bases for the Helmholtz problem" href="mixingbases.html" />
    <link rel="prev" title="Demo - Eigenvalues on the Möbius strip" href="moebius.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/seashell3.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Shenfun executable demos</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Shenfun executable demos
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Shenfun executable demos
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="poisson.html">
   Demo - 1D Poisson’s equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kleingordon.html">
   Demo - Cubic nonlinear Klein-Gordon equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="poisson3d.html">
   Demo - 3D Poisson’s equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="polarhelmholtz.html">
   Demo - Helmholtz equation in polar coordinates
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sphericalhelmholtz.html">
   Demo - Helmholtz equation on the unit sphere
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="kuramatosivashinsky.html">
   Demo - Kuramato-Sivashinsky equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stokes.html">
   Demo - Stokes equations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="drivencavity.html">
   Demo - Lid driven cavity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rayleighbenard.html">
   Demo - Rayleigh Benard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="functions.html">
   Demo - Working with Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="surfaceintegration.html">
   Demo - Integration of functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="moebius.html">
   Demo - Eigenvalues on the Möbius strip
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Demo - Some fast transforms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mixingbases.html">
   Demo - Mixed bases for the Helmholtz problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tau.html">
   Demo - The Tau method
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/content/fasttransforms.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/mikaem/shenfun-demos"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/mikaem/shenfun-demos/master?urlpath=tree/content/fasttransforms.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> On this page
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-fast-transforms">
   The fast transforms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fast-transform-for-t-k-t-k-2">
   Fast transform for
   <span class="math notranslate nohighlight">
    \(T_k-T_{k+2}\)
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fast-transform-for-1-x-2-t-k">
   Fast transform for
   <span class="math notranslate nohighlight">
    \((1-x^2)T_k\)
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fast-transform-for-u-k-frac-k-1-k-3-u-k-2">
   Fast transform for
   <span class="math notranslate nohighlight">
    \(U_k-\frac{k+1}{k+3}U_{k+2}\)
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implementation">
   Implementation
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <!-- dom:TITLE: Demo - Some fast transforms -->
<div class="section" id="demo-some-fast-transforms">
<h1>Demo - Some fast transforms<a class="headerlink" href="#demo-some-fast-transforms" title="Permalink to this headline">¶</a></h1>
<!-- dom:AUTHOR: Mikael Mortensen Email:mikaem@math.uio.no at Department of Mathematics, University of Oslo. -->
<!-- Author: -->  
<p><strong>Mikael Mortensen</strong> (email: <code class="docutils literal notranslate"><span class="pre">mikaem&#64;math.uio.no</span></code>), Department of Mathematics, University of Oslo.</p>
<p>Date: <strong>Jun 18, 2021</strong></p>
<p>Copyright 2021, Mikael Mortensen. Released under CC Attribution 4.0 license</p>
<p><strong>Summary.</strong> This demo shows how to compute fast forward transforms for three
different Dirichlet bases.</p>
<div class="section" id="the-fast-transforms">
<h2>The fast transforms<a class="headerlink" href="#the-fast-transforms" title="Permalink to this headline">¶</a></h2>
<p>We will consider the fast forward transforms for the three
Chebyshev Dirichlet basis functions</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:shen"></a></p>
<div class="math notranslate nohighlight">
\[
\label{eq:shen} \tag{1}
\phi_k = T_k-T_{k+2}, \quad k=0,1, \ldots, N-3,
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="eq:heinrichs"></a></p>
<div class="math notranslate nohighlight">
\[
\label{eq:heinrichs} \tag{2}
\varphi_k = (1-x^2)T_k, \quad k=0,1, \ldots, N-3,
\]</div>
<!-- Equation labels as ordinary links -->
<p><a id="eq:dirichletU"></a></p>
<div class="math notranslate nohighlight">
\[
\label{eq:dirichletU} \tag{3}
\psi_k = U_k-\frac{k+1}{k+3}U_{k+2}, \quad k=0,1, \ldots, N-3,
\]</div>
<p>That is, we test fast methods for projection of a function
<span class="math notranslate nohighlight">\(u(x)\)</span> into spaces <span class="math notranslate nohighlight">\(V_{\phi} = \text{span}\{\phi_k\}_{k=0}^{N-3}\)</span>,
<span class="math notranslate nohighlight">\(V_{\varphi} = \text{span}\{\varphi_k\}_{k=0}^{N-3}\)</span> and
<span class="math notranslate nohighlight">\(V_{\psi} = \text{span}\{\psi_k\}_{k=0}^{N-3}\)</span>.
For each space the projection is:
find <span class="math notranslate nohighlight">\(u_N \in V_{\alpha}\)</span> such that</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:projection"></a></p>
<div class="math notranslate nohighlight">
\[
\label{eq:projection} \tag{4}
(u_N-u, v)_{\omega} = 0, \quad \forall \, v \in V_{\alpha},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha \in (\phi, \varphi, \psi)\)</span>. The solutions we are after are thus</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto1"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
u(x) = \sum_{k=0}^{N-3} \hat{u}_k^{\alpha} \alpha_k(x),
\label{_auto1} \tag{5}
\end{equation}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha_k\)</span> can be any of the three basis functions <span class="math notranslate nohighlight">\((\phi_k, \varphi_k, \psi_k)\)</span>.</p>
<p>A direct method to solve Eq. (<a class="reference external" href="#eq:projection">4</a>) is to insert for
<span class="math notranslate nohighlight">\(u_N = \sum_{j=0}^{N-3}\hat{u}_j^{\alpha} \alpha_j\)</span> and <span class="math notranslate nohighlight">\(v = \alpha_k\)</span> to obtain</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:genericproj"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\label{eq:genericproj} \tag{6}
(\alpha_j, \alpha_k)_{\omega} \hat{u}_j^{\alpha} = (u, \alpha_k)_{\omega},
\end{equation}
\]</div>
<p>which on algebraic form is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
B \hat{\boldsymbol{u}} &amp;= \tilde{\boldsymbol{u}}, \\ 
\hat{\boldsymbol{u}} &amp;= B^{-1} \tilde{\boldsymbol{u}},
\end{align*}
\end{split}\]</div>
<p>where the mass matrix <span class="math notranslate nohighlight">\(B \in \mathbb{R}^{N-2 \times N-2} = \{(\alpha_j, \alpha_k)_{\omega}\}_{k,j=0}^{N-3}\)</span>, <span class="math notranslate nohighlight">\(\tilde{\boldsymbol{u}} = \{(u, \alpha_k)_{\omega}\}_{k=0}^{N-3}\)</span> and <span class="math notranslate nohighlight">\(\boldsymbol{u} = \{\hat{u}_k^{\alpha}\}_{k=0}^{N-3}\)</span>.
A fast method is found if <span class="math notranslate nohighlight">\(B\)</span> is diagonal, so that the inversion <span class="math notranslate nohighlight">\(B^{-1}\)</span> is trivial. In this case the projection becomes orthogonal.
It can be shown that the three bases are orthogonal using weights <span class="math notranslate nohighlight">\(\omega = (1-x^2)^{\sigma}\)</span>,
where <span class="math notranslate nohighlight">\(\sigma = -3/2, -5/2\)</span> and <span class="math notranslate nohighlight">\(-1/2\)</span>, for (<a class="reference external" href="#eq:shen">1</a>), (<a class="reference external" href="#eq:heinrichs">2</a>) and (<a class="reference external" href="#eq:dirichletU">3</a>), respectively.</p>
<p>In the following all methods will make use of Gauss-Chebyshev
quadrature with Gauss-Chebyshev collocation points
<span class="math notranslate nohighlight">\(\boldsymbol{x}=\{x_i\}_{i=0}^{N-1}\)</span>, where
<span class="math notranslate nohighlight">\(x_i = \cos(\theta_i)\)</span>, <span class="math notranslate nohighlight">\(\theta_i=\pi (2i+1)/(2N)\)</span> and
<span class="math notranslate nohighlight">\(\boldsymbol{\theta}=\{\theta_i\}_{i=0}^{N-1}\)</span>. The quadrature weights
are then constant <span class="math notranslate nohighlight">\(w_i = \pi/N\)</span> for <span class="math notranslate nohighlight">\(i=0,1, \ldots, N-1\)</span>.</p>
</div>
<div class="section" id="fast-transform-for-t-k-t-k-2">
<h2>Fast transform for <span class="math notranslate nohighlight">\(T_k-T_{k+2}\)</span><a class="headerlink" href="#fast-transform-for-t-k-t-k-2" title="Permalink to this headline">¶</a></h2>
<p>The basis function <span class="math notranslate nohighlight">\(\phi_k=T_k-T_{k+2}\)</span> can be written as <span class="math notranslate nohighlight">\(\phi_k=2(1-x^2)U_k\)</span> because of the
recurrence formulas <span class="math notranslate nohighlight">\(T_{k+2}=xT_{k+1}-(1-x^2)U_{k}\)</span> and <span class="math notranslate nohighlight">\(T_{k+2}=2xT_{k+1}-T_k\)</span>.
Using <span class="math notranslate nohighlight">\(\phi_k=2(1-x^2)U_k\)</span> for both test and trial functions in (<a class="reference external" href="#eq:genericproj">6</a>),
we get</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:projectionSD3"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\label{eq:projectionSD3} \tag{7}
    \int_I 2U_jU_k \omega^{1/2}dx \hat{u}_j^{\phi} = \int_I U_k u \omega^{-1/2}dx,
\end{equation}
\]</div>
<p>where <span class="math notranslate nohighlight">\(I=[-1, 1]\)</span> and the integral on the left equals <span class="math notranslate nohighlight">\(\pi\delta_{kj}\)</span>.
The integral on the right is solved through Gauss-Chebyshev quadrature
using the identity <span class="math notranslate nohighlight">\(U_k(\cos \theta_i) = \sin((k+1)\theta_i)/\sin \theta_i\)</span>,
which reduces the problem to one single discrete sine transform of type 2.
We get for the integral on the right</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto2"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\int_I U_k u \omega^{-1/2}dx \approx \sum_{i=0}^{N-1} u(x_i) \sin((k+1)\theta_i)/\sin \theta_i,
\label{_auto2} \tag{8}
\end{equation}
\]</div>
<p>which can be computed using the discrete sine transform (DST) of type 2,
see <a class="reference external" href="http://www.fftw.org/fftw3_doc/1d-Real_002dodd-DFTs-_0028DSTs_0029.html">FFTW</a>.
Inserting this DST in (<a class="reference external" href="#eq:projectionSD3">7</a>) we get the final expression
for the fast forward transform</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:proju0"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\label{eq:proju0} \tag{9}
    \hat{u}_k^{\phi} = \frac{1}{2N} \text{dst}^{II}(u(\boldsymbol{x})/\sin \boldsymbol{\theta})_k, \quad k=0, 1, \ldots, N-3.
\end{equation}
\]</div>
<p>Note that we only use the first <span class="math notranslate nohighlight">\(N-2\)</span> components of the sine transform, but the two
highest frequencies are identically 0, so we would not make an error or do anything differently by
using the entire array. Also note that the division of the two arrays <span class="math notranslate nohighlight">\(u(\boldsymbol{x})/\sin \boldsymbol{\theta}\)</span> is elementwise.</p>
</div>
<div class="section" id="fast-transform-for-1-x-2-t-k">
<h2>Fast transform for <span class="math notranslate nohighlight">\((1-x^2)T_k\)</span><a class="headerlink" href="#fast-transform-for-1-x-2-t-k" title="Permalink to this headline">¶</a></h2>
<p>The orthogonal projection of <span class="math notranslate nohighlight">\(u(x)\)</span> for basis (<a class="reference external" href="#eq:heinrichs">2</a>)
in <span class="math notranslate nohighlight">\(L^2_{\omega^{-5/2}}(I)\)</span> reads</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto3"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
    \int_I T_j T_k \omega^{-1/2} dx \hat{u}_j^{\varphi} = \int_I T_k u \omega^{-3/2} dx.
\label{_auto3} \tag{10}
\end{equation}
\]</div>
<p>The left hand side is simply the diagonal <span class="math notranslate nohighlight">\((T_j, T_k)_{\omega^{-1/2}} = c_k\pi/2 \delta_{kj}\)</span>.
For the integral on the right we use the Gauss-Chebyshev quadrature rule for
integration with weight <span class="math notranslate nohighlight">\((1-x^2)^{-1/2}\)</span>, and rewrite using
<span class="math notranslate nohighlight">\(1-x_i^2=\sin^2\theta_i\)</span> and <span class="math notranslate nohighlight">\(T_k(x_i) = \cos(k\theta_i)\)</span></p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto4"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
    \frac{c_k \pi}{2} \hat{u}_k^{\varphi} = \frac{\pi}{N} \sum_{i=0}^{N-1} \cos (k \theta_i) u(x_i)/\sin^2\theta_i.
\label{_auto4} \tag{11}
\end{equation}
\]</div>
<p>The sum can be seen to be a discrete cosine transform of type 2. We get the
final expression for the fast transform</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto5"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
    \hat{u}_k^{\varphi} = \frac{1}{c_k N} \text{dct}^{II} (u(\boldsymbol{x})/\sin^2 \boldsymbol{\theta})_k, \quad k=0, 1, \ldots, N-3.
\label{_auto5} \tag{12}
\end{equation}
\]</div>
</div>
<div class="section" id="fast-transform-for-u-k-frac-k-1-k-3-u-k-2">
<h2>Fast transform for <span class="math notranslate nohighlight">\(U_k-\frac{k+1}{k+3}U_{k+2}\)</span><a class="headerlink" href="#fast-transform-for-u-k-frac-k-1-k-3-u-k-2" title="Permalink to this headline">¶</a></h2>
<p>The orthogonal projection for basis <span class="math notranslate nohighlight">\(\{\psi_k\}_{k=0}^{N-3}\)</span> in
<span class="math notranslate nohighlight">\(L^2_{\omega^{-1/2}}(I)\)</span> can be computed using the alternative form</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:elbarbary"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
   \psi_k = \frac{2(1-x^2)}{(k+2)(k+3)}T^{ ''}_{k+2}, \quad k = 0, 1, \ldots, N-3.
\label{eq:elbarbary} \tag{13}
\end{equation}
\]</div>
<p>Using (<a class="reference external" href="#eq:elbarbary">13</a>) for the two basis functions in <span class="math notranslate nohighlight">\((\psi_j, \psi_k)_{\omega^{-1/2}}\)</span>,
and (<a class="reference external" href="#eq:dirichletU">3</a>) in the linear form we get</p>
<!-- Equation labels as ordinary links -->
<p><a id="eq:proj3"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
\label{eq:proj3} \tag{14}
    \frac{4}{(k+2)^2(k+3)^2}\int_I T^{''}_j T^{''}_k \omega^{3/2}dx \hat{u}_j^{\psi} = \int_I (U_k - \frac{k+1}{k+3}U_{k+2})u \omega^{-1/2} dx.
\end{equation}
\]</div>
<p>Using the orthogonal <span class="math notranslate nohighlight">\(\int_I T^{''}_j T^{''}_k \omega^{3/2}dx = \pi (j+1)(j+2)^2(j+3)/2 \delta_{kj}\)</span> from Lemma 3
in <a class="reference external" href="#elbarbary08">[elbarbary08]</a>, Eq. (<a class="reference external" href="#eq:proj3">14</a>) simplifies to</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto6"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
     \frac{2 \pi (k+1)}{(k+3)} \hat{u}_k^{\psi}  = \int_I (U_k - \frac{k+1}{k+3}U_{k+2})u \omega^{-1/2} dx.
\label{_auto6} \tag{15}
\end{equation}
\]</div>
<p>The right hand side can now be rewritten using the same sine transform as in (<a class="reference external" href="#eq:proju0">9</a>).
We get after some rearrangements</p>
<!-- Equation labels as ordinary links -->
<p><a id="_auto7"></a></p>
<div class="math notranslate nohighlight">
\[
\begin{equation}
    \hat{u}_k^{\psi} = \frac{k+3}{2(k+1)}\hat{u}_k^{\phi} - \frac{1}{2}\hat{u}_{k+2}^{\phi}, \quad k=0, 1, \ldots, N-3.
\label{_auto7} \tag{16}
\end{equation}
\]</div>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>To validate these methods we compute the projection first regularly
using the Shenfun function <a class="reference external" href="https://github.com/spectralDNS/shenfun/blob/master/shenfun/forms/project.py">project</a>,
which is using <span class="math notranslate nohighlight">\(\sigma=-1/2\)</span>, and then the fast methods above. The two
projections should be the same, but they will not give identical results.
In general, the fast transforms above should be both faster and more
accurate, because they only take a discrete transform and no
mass matrix inversion.</p>
<p>Start by importing necessary modules from Shenfun and mpi4py-fft</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shenfun</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mpi4py_fft</span> <span class="kn">import</span> <span class="n">fftw</span>
</pre></div>
</div>
</div>
</div>
<p>Create function spaces for all three Dirichlet bases. Decide on a number of quadrature points (not important), and just use default quadrature scheme, which is the Gauss-Chebyshev points.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">D0</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;ShenDirichlet&#39;</span><span class="p">)</span>
<span class="n">D1</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;Heinrichs&#39;</span><span class="p">)</span>
<span class="n">D2</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;DirichletU&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a random vector that we will use for testing.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">D0</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>
<span class="n">fb</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Do the regular projection. Now <code class="docutils literal notranslate"><span class="pre">f0</span></code>, <code class="docutils literal notranslate"><span class="pre">f1</span></code> and <code class="docutils literal notranslate"><span class="pre">f2</span></code> will be the three solution vectors <span class="math notranslate nohighlight">\(\boldsymbol{\hat{u}}^{\phi}\)</span>, <span class="math notranslate nohighlight">\(\boldsymbol{\hat{u}}^{\varphi}\)</span> and <span class="math notranslate nohighlight">\(\boldsymbol{\hat{u}}^{\psi}\)</span>.</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f0</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">D0</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">D1</span><span class="p">)</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">D2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now compute the fast transforms and assert that they are equal to <code class="docutils literal notranslate"><span class="pre">f0</span></code>, <code class="docutils literal notranslate"><span class="pre">f1</span></code> and <code class="docutils literal notranslate"><span class="pre">f2</span></code></p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">fftw</span><span class="o">.</span><span class="n">dstn</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">d0</span> <span class="o">=</span> <span class="n">dst</span><span class="p">(</span><span class="n">fb</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d0</span><span class="o">-</span><span class="n">f0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span>
<span class="n">dct</span> <span class="o">=</span> <span class="n">fftw</span><span class="o">.</span><span class="n">dctn</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ck</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">);</span> <span class="n">ck</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">dct</span><span class="p">(</span><span class="n">fb</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ck</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d1</span><span class="o">-</span><span class="n">f1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d1</span><span class="o">-</span><span class="n">f1</span><span class="p">)</span>
<span class="n">ut</span> <span class="o">=</span> <span class="n">d0</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">D2</span><span class="p">)</span>
<span class="n">d2</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ut</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">d2</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ut</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d2</span><span class="o">-</span><span class="n">f2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span>
</pre></div>
</div>
</div>
</div>
<p>That’s it! If you make it to here with no errors, then the three tests pass, and the fast transforms are equal to the slow ones, at least within given precision.</p>
<p>Let’s try some timings</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">timeit</span> <span class="n">project</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">D0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">timeit</span> <span class="n">dst</span><span class="p">(</span><span class="n">fb</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can precompute the sine term, because it does not change</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">dst</span><span class="p">(</span><span class="n">fb</span><span class="o">/</span><span class="n">dd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The other two transforms are about equally fast</p>
<div class="cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">timeit</span> <span class="n">dct</span><span class="p">(</span><span class="n">fb</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ck</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<!-- ======= Bibliography ======= -->
<ol class="simple">
<li><p><a id="elbarbary08"></a> <strong>E. M. E. Elbarbary</strong>.
Efficient Chebyshev-Petrov-Galerkin Method for Solving Second-Order Equations,
<em>Journal of Scientific Computing</em>,
34(2),
pp. 113-126,
<a class="reference external" href="http://dx.doi.org/10.1007/s10915-007-9161-9">doi: 10.1007/s10915-007-9161-9</a>,
2008.</p></li>
</ol>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "mikaem/shenfun-demos",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="moebius.html" title="previous page">Demo - Eigenvalues on the Möbius strip</a>
    <a class='right-next' id="next-link" href="mixingbases.html" title="next page">Demo - Mixed bases for the Helmholtz problem</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Mikael Mortensen<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>